{# camera control settings #}

<div class="container">
    <br><br>
    <h1>Camera Settings</h1>
    <p>For camera: {{ camera.Model }}</p>
    <!-- Hiding the toggle live preview for now as I am thinking its not needed but I don't want to kill it totally just yet
    
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="videoFeedToggle" data-camera-num="0">
        <label class="form-check-label" for="videoFeedToggle">Toggle Live Preview</label>
    </div> -->

    <!-- Accordion for organizing sections -->
    <div class="accordion pt-4" id="settingsAccordion">
        {% for section in settings.sections if section.enabled %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#section{{ loop.index }}">
                    {{ section.name }}
                </button>
            </h2>
            <div id="section{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                    
                    <!-- Loop through settings within a section -->
                    {% for setting in section.settings if setting.enabled %}
                    
                        <!-- Include setting-specific template dynamically -->
                        {% include "settings/" + setting.type + ".html" %}

                        <!-- Handle Child Settings (conditionally displayed) -->
                        {% if setting.childsettings %}
                            <div id="{{ setting.id }}_dependencies" class="collapse" data-parent="{{ setting.id }}">
                                {% for child in setting.childsettings if child.enabled %}
                                    {% set setting = child %}
                                    {% include "settings/" + child.type + ".html" %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    
                    {% endfor %} <!-- End settings loop -->

                </div>
            </div>
        </div>
        {% endfor %} <!-- End section loop -->
    </div>

</div>

<div class="mt-4"></div> <!-- Gap between sections -->
    
<!-- Sensor Mode Selection Accordion -->
<div class="accordion" id="sensorModeAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingSensorModes">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSensorModes" aria-expanded="false" aria-controls="collapseSensorModes">
                Sensor Modes
            </button>
        </h2>
        <div id="collapseSensorModes" class="accordion-collapse collapse" aria-labelledby="headingSensorModes" data-bs-parent="#cameraControls">
            <div class="accordion-body">
                <ul class="list-group">
                    {% for mode in sensor_modes %}
                    <li class="list-group-item">
                        <input class="form-check-input me-1" 
                               type="radio" 
                               name="sensor-mode" 
                               id="sensor-mode{{ loop.index0 }}" 
                               onclick="updateRadioSetting('sensor-mode', '{{ loop.index0 }}')"
                               {% if loop.index0 == active_mode_index|int %}checked{% endif %}>
                        <label class="form-check-label" for="sensor-mode{{ loop.index0 }}">
                            <strong class="fw-semibold">Mode {{ loop.index0 }}</strong>
                            <span class="d-block small opacity-75">Resolution: {{ mode['size'] }}</span>
                            <span class="d-block small opacity-75">FPS: {{ mode['fps'] }}</span>
                            <span class="d-block small opacity-75">Crop Limits: {{ mode['crop_limits'] }}</span>
                        </label>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProfile" aria-expanded="false" aria-controls="collapseProfile">
                Load/Save Camera Profile
            </button>
        </h2>
        <div id="collapseProfile" class="accordion-collapse collapse" data-bs-parent="#accordionCameraControls">
            <div class="accordion-body">
                <!-- Button Group -->
                <div class="btn-group" role="group" aria-label="Profile Actions">
                    <button type="button" class="btn btn-primary active" onclick="showProfileSection('loadProfile')">Load Profile</button>
                    <button type="button" class="btn btn-primary" onclick="showProfileSection('saveProfile')">Save Profile</button>
                    <button type="button" class="btn btn-danger" onclick="showProfileSection('resetProfile')">Reset to Default</button>
                  </div>
                  <br></br>
                <!-- Profile Sections -->
                <div id="loadProfile" class="profile-section">
                    <div class="alert alert-danger d-none" id="configAlert" role="alert"></div>
                    <table class="table" id="configTable">
                        <thead>
                            <tr>
                                <th scope="col">Select</th>
                                <th scope="col">Filename</th>
                                <th scope="col">Model</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if config_data %}
                                {% for i, config in enumerate(config_data) %}
                                    <tr>
                                        <td>
                                            <input type="radio" name="selectedConfig" value="{{ config.filename }}" data-model="{{ config.model }}" {% if config.is_selected %}checked{% endif %}>
                                        </td>
                                        <td>{{ config.filename }}</td>
                                        <td>{{ config.model }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="3">No profiles saved</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-primary" onclick="loadConfigFile()">Load Selected Profile</button>
                </div>

                <div id="saveProfile" class="profile-section d-none">
                    <p>Enter filename you wish to use:</p>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="saveConfigFile" placeholder="Enter filename">
                        <div class="form-text">Using a filename that already exists will overwrite that file.</div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveProfile({{ camera.Num }})">Save Profile</button>
                </div>
    
                <div id="resetProfile" class="profile-section d-none">
                    <p class="mb-1">Just checking, are you sure?</p>
                    <button type="button" class="btn btn-danger" onclick="resetProfile({{ camera.Num }})">Reset to Default</button>
                </div>
<br>
                <!-- Bootstrap Alert (Shared across Load, Save, Reset) -->
                    <div class="alert alert-danger d-none" id="profileAlert" role="alert"></div>

            </div>
        </div>
    </div>
    
    <script>
        function showProfileSection(sectionId) {
    // Hide all profile sections
    document.querySelectorAll('.profile-section').forEach(section => {
        section.classList.add('d-none');
    });

    // Show the selected section
    document.getElementById(sectionId).classList.remove('d-none');

    // Remove 'active' class from all buttons
    document.querySelectorAll('.btn-group .btn').forEach(button => {
        button.classList.remove('active');
    });

    // Add 'active' class to the clicked button
    event.target.classList.add('active');
}

function saveProfile(cameraNum) {
    const filename = document.getElementById("saveConfigFile").value;
    const alertBox = document.getElementById("profileAlert");

    if (!filename) {
        showAlert(alertBox, "danger", "Please enter a filename.");
        return;
    }

    fetch(`/save_profile_${cameraNum}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ filename: filename })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showAlert(alertBox, "success", data.message);
        } else {
            showAlert(alertBox, "danger", data.error || "Failed to save profile.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
        showAlert(alertBox, "danger", "An unexpected error occurred.");
    });
}

function resetProfile(cameraNum) {
    fetch(`/reset_profile_${cameraNum}`, { 
        method: "POST"
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert("Profile reset to default!", "success");
        } else {
            showAlert("Error: " + data.message, "danger");
        }
    })
    .catch(error => {
        showAlert("Request failed: " + error, "danger");
    });
}

function showAlert(element, type, message) {
    element.className = `alert alert-${type}`;
    element.innerText = message;
    element.classList.remove("d-none");

    setTimeout(() => {
        element.classList.add("d-none");
    }, 5000);
}
    </script>



</div>

<!-- JavaScript to toggle child settings visibility based on parent state -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Initialize visibility for switches
    document.querySelectorAll('.form-check-input[type="checkbox"]').forEach(switchElement => {
        let settingId = switchElement.id;
        toggleChildSettings(settingId, switchElement.checked);

        switchElement.addEventListener("change", function () {
            toggleChildSettings(settingId, this.checked);
        });
    });

    // Initialize visibility for radio buttons
    document.querySelectorAll('.form-check-input[type="radio"]').forEach(radioElement => {
        let settingId = radioElement.name;  // Radio buttons share a name
        updateRadioChildVisibility(settingId);

        radioElement.addEventListener("change", function () {
            updateRadioChildVisibility(settingId);
        });
    });
});

// Function to show/hide child settings based on checkbox switches
function toggleChildSettings(settingId, isChecked) {
    document.querySelectorAll(`#${settingId}_dependencies`).forEach(childElement => {
        if (isChecked) {
            childElement.classList.add("show");
        } else {
            childElement.classList.remove("show");
        }
    });
}

// Function to show/hide child settings based on radio selection
function updateRadioChildVisibility(settingId) {
    let selectedRadio = document.querySelector(`input[name="${settingId}"]:checked`);
    
    if (selectedRadio) {
        let showChild = selectedRadio.dataset.showChild === "true";
        let dependencies = document.getElementById(settingId + "_dependencies");

        if (dependencies) {
            dependencies.style.display = showChild ? "block" : "none";
        }
    }
}

let camera_num = {{ camera.Num }};

// Generic function to send updated settings to Flask
function updateSetting(settingId, newValue) {
    fetch("/update_setting", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            camera_num: camera_num, 
            id: settingId,
            value: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`Updated: Camera ${camera_num}, ${settingId} -> ${newValue}`);
        } else {
            console.error("Error updating setting:", data.error);
        }
    })
    .catch(error => console.error("Request failed:", error));
}

// Function for slider settings
function adjustSliderSetting(settingId, value) {
    let valueLabel = document.getElementById("current" + settingId);
    if (valueLabel) {
        valueLabel.textContent = `Value: ${value}`;
    }
    updateSetting(settingId, value);
}

// Function for switch settings
function toggleSwitchSetting(settingId) {
    let switchElement = document.getElementById(settingId);
    let newValue = switchElement.checked; // true/false
    updateSetting(settingId, newValue);
}

function updateRadioSetting(settingId, value) {
    console.log(`Radio changed: ${settingId} -> ${value}`);
    updateSetting(settingId, value);
    updateRadioChildVisibility(settingId);
}

document.addEventListener("DOMContentLoaded", function () {
    const videoToggle = document.getElementById("videoFeedToggle");
    const videoFeed = document.getElementById("videoFeed");

    videoToggle.addEventListener("change", function () {

        if (this.checked) {
            videoFeed.src = `/video_feed_${camera_num}`; // Set the correct video stream URL
        } else {
            videoFeed.src = "/static/placeholder.jpg"; // Show placeholder when off
        }

        // Send toggle state and camera number to Flask backend
        fetch("/toggle_video_feed", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enable: this.checked, camera_num: camera_num })
        });
    });
});


</script>
