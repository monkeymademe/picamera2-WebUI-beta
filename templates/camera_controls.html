{% extends 'base.html' %}
{% block content %}

<div class="container">
    <br><br>
    <h1>Camera Settings</h1>
    <p>For camera: {{ camera.Model }}</p>

    <!-- Accordion for organizing sections -->
    <div class="accordion pt-4" id="settingsAccordion">
        {% for section in settings.sections if section.enabled %}
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#section{{ loop.index }}">
                    {{ section.name }}
                </button>
            </h2>
            <div id="section{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                    
                    <!-- Loop through settings within a section -->
                    {% for setting in section.settings if setting.enabled %}
                    
                        <!-- Include setting-specific template dynamically -->
                        {% include "settings/" + setting.type + ".html" %}

                        <!-- Handle Child Settings (conditionally displayed) -->
                        {% if setting.childsettings %}
                            <div id="{{ setting.id }}_dependencies" class="collapse" data-parent="{{ setting.id }}">
                                {% for child in setting.childsettings if child.enabled %}
                                    {% set setting = child %}
                                    {% include "settings/" + child.type + ".html" %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    
                    {% endfor %} <!-- End settings loop -->

                </div>
            </div>
        </div>
        {% endfor %} <!-- End section loop -->
    </div>

</div>

<!-- JavaScript to toggle child settings visibility based on parent state -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Initialize visibility for switches
    document.querySelectorAll('.form-check-input[type="checkbox"]').forEach(switchElement => {
        let settingId = switchElement.id;
        toggleChildSettings(settingId, switchElement.checked);

        switchElement.addEventListener("change", function () {
            toggleChildSettings(settingId, this.checked);
        });
    });

    // Initialize visibility for radio buttons
    document.querySelectorAll('.form-check-input[type="radio"]').forEach(radioElement => {
        let settingId = radioElement.name;  // Radio buttons share a name
        updateRadioChildVisibility(settingId);

        radioElement.addEventListener("change", function () {
            updateRadioChildVisibility(settingId);
        });
    });
});

// Function to show/hide child settings based on checkbox switches
function toggleChildSettings(settingId, isChecked) {
    document.querySelectorAll(`#${settingId}_dependencies`).forEach(childElement => {
        if (isChecked) {
            childElement.classList.add("show");
        } else {
            childElement.classList.remove("show");
        }
    });
}

// Function to show/hide child settings based on radio selection
function updateRadioChildVisibility(settingId) {
    let selectedRadio = document.querySelector(`input[name="${settingId}"]:checked`);
    
    if (selectedRadio) {
        let showChild = selectedRadio.dataset.showChild === "true";
        let dependencies = document.getElementById(settingId + "_dependencies");

        if (dependencies) {
            dependencies.style.display = showChild ? "block" : "none";
        }
    }
}

let camera_num = {{ camera.Num }};

// Generic function to send updated settings to Flask
function updateSetting(settingId, newValue) {
    fetch("/update_setting", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            camera_num: camera_num, 
            id: settingId,
            value: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`Updated: Camera ${camera_num}, ${settingId} -> ${newValue}`);
        } else {
            console.error("Error updating setting:", data.error);
        }
    })
    .catch(error => console.error("Request failed:", error));
}

// Function for slider settings
function adjustSliderSetting(settingId, value) {
    let valueLabel = document.getElementById("current" + settingId);
    if (valueLabel) {
        valueLabel.textContent = `Value: ${value}`;
    }
    updateSetting(settingId, value);
}

// Function for switch settings
function toggleSwitchSetting(settingId) {
    let switchElement = document.getElementById(settingId);
    let newValue = switchElement.checked; // true/false
    updateSetting(settingId, newValue);
}

function updateRadioSetting(settingId, value) {
    console.log(`Radio changed: ${settingId} -> ${value}`);
    updateSetting(settingId, value);
    updateRadioChildVisibility(settingId);
}
</script>

{% endblock %}