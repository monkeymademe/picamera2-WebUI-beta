{% extends 'base.html' %}

{% block content %}
<div class="container-fluid p-0">
    <div class="row no-gutters">
        <!-- Sidebar with buttons -->
        <div class="col-auto d-flex flex-column align-items-center p-2 bg-dark" style="width: 60px;">
            <button class="btn btn-light mb-3" onclick="location.href='/'">
                <i class="bi bi-house"></i>
            </button>
            <button class="btn btn-light mb-3" onclick="location.href='/image_gallery'">
                <i class="bi bi-images"></i>
            </button>
            <button class="btn btn-light mb-3" id="captureButton">
                <i class="bi bi-camera"></i>
            </button>
            <button class="btn btn-light" data-bs-toggle="offcanvas" data-bs-target="#cameraSettings">
                <i class="bi bi-gear"></i>
            </button>
        </div>

        <!-- Video Stream -->
        <div class="col text-center">
            <img id="videoStream" src="/video_feed_{{camera.Num}}" class="img-fluid" style="max-height: 100vh; object-fit: contain;">
        </div>
    </div>
</div>

<!-- Offcanvas for Camera Settings -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cameraSettings">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Camera Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        {% include 'camera_controls.html' %}
    </div>
</div>

<script>
document.getElementById("captureButton").addEventListener("click", function() {
    let button = document.getElementById("captureButton");
    button.disabled = true; // Disable button while processing

    fetch("/capture_still_{{ camera.Num }}", { method: "POST" })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let img = document.getElementById("pimage");

            if (img) {  // Ensure the image element exists before modifying it
                img.src = `{{ url_for('static', filename='gallery/') }}${data.image}.jpg`;
            } else {
                console.warn("Image preview element (#pimage) not found in the DOM.");
            }

            console.log('Photo Captured:', data.image);
            reloadVideoStream();  // Force refresh video feed
        } else {
            console.error("Capture error:", data.message);
        }
    })
    .catch(error => {
        console.error("Capture error:", error);
    })
    .finally(() => {
        button.disabled = false; // Re-enable button
    });
});

function reloadVideoStream() {
    let img = document.getElementById("videoStream");
    if (img) {
        img.remove();  // Remove the image from the DOM
    }

    // Create a new image element
    let newImg = document.createElement("img");
    newImg.id = "videoStream";
    newImg.src = "/video_feed_{{ camera.Num }}?t=" + new Date().getTime();  // Cache-busting
    newImg.className = "img-fluid";
    newImg.style = "max-height: 100vh; object-fit: contain;";

    // Append back into the same parent
    document.querySelector(".col.text-center").appendChild(newImg);
}
</script>
{% endblock %}
